---
title: "BRCindicators - Notes of core functionality and benchmarking"
author: "Dylan Carbone"
date: "June 2024"
output:
  html_document:
    keep_md: yes
    toc: yes
---
**This shows how us to use the indicator pipeline to create biodiversity indicators such as those for DEFRA Biodiversity Indicators in Your Pocke.**

**BRCindicators works with yearly estimates of species abundance or occurrence and aggregate them into an scaled indicator value with bootstrapped confidence intervals.**

First, we create some example data. NOTE, the format is the same as the data created within the sparta vignette.
```{r create_some_data}
# Create data
n <- 8000 # size of dataset
nyr <- 50 # number of years in data
nSamples <- 200 # set number of dates
nSites <- 100 # set number of sites
set.seed(125) # set a random seed

# Create somes dates
first <- as.Date(strptime("1950/01/01", "%Y/%m/%d")) 
last <- as.Date(strptime(paste(1950+(nyr-1),"/12/31", sep=''), "%Y/%m/%d")) 
dt <- last-first 
rDates <- first + (runif(nSamples)*dt)

# taxa are set semi-randomly
taxa_probabilities <- seq(from = 0.1, to = 0.7, length.out = 26)
taxa <- sample(letters, size = n, TRUE, prob = taxa_probabilities)

# sites are visited semi-randomly
site_probabilities <- seq(from = 0.1, to = 0.7, length.out = nSites)
site <- sample(paste('A', 1:nSites, sep=''), size = n, TRUE, prob = site_probabilities)

# the date of visit is selected semi-randomly from those created earlier
time_probabilities <- seq(from = 0.1, to = 0.7, length.out = nSamples)
time_period <- sample(rDates, size = n, TRUE, prob = time_probabilities)

myData <- data.frame(taxa, site, time_period)
```

```{r}
# Load sparta
library(sparta)

# First format our data
formattedOccData <- formatOccData(taxa = myData$taxa,
                                  site = myData$site,
                                  survey = myData$time_period)

# I create a function that takes a species name and runs my model
occ_mod_function <- function(taxa_name){
  
  # Note that this will write you results to your computer
  # the location is set to your user folder
  occ_out <- sparta::occDetFunc(taxa_name = as.character(taxa_name),
                        n_iterations = 200,
                        burnin = 15, 
                        occDetdata = formattedOccData$occDetdata,
                        spp_vis = formattedOccData$spp_vis,
                        write_results = TRUE,
                        output_dir = '~/Testing_indicator_pipe',
                        seed = 123)  
} 
# I then run this
para_out <- sapply(unique(myData$taxa), occ_mod_function)

```

**Now that we have some species trends data to work with, we can use the first function in BRCindicators. This function reads in all the output files from sparta and returns a simple summary table that we can use for calculating the indicator.**

```{r set_up_run}
library(BRCindicators)

# All we have to supply is the directory where out data is saved
# You will note this is the 'output_dir' passed to sparta above.
trends_summary <- summarise_occDet(para_out)

# Lets see the summary
head(trends_summary[,1:5])
```

**Returned from this function is a summary of the data as a matrix. In each row we have the year, specified in the first column, and each subsequent column is a species.**